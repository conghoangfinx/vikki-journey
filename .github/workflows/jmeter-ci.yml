name: JMeter CI Test (Manual)

on:
  workflow_dispatch:

jobs:
  jmeter-test:
    runs-on: self-hosted  # Ch·∫°y tr√™n m√°y c√° nh√¢n c√≥ VPN

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Check & Install Dependencies
        run: |
          echo "üîç Checking dependencies..."
          if ! command -v gtimeout &> /dev/null
          then
              echo "‚ö†Ô∏è 'timeout' command not found! Installing coreutils..."
              brew install coreutils
          fi

          if ! command -v jmeter &> /dev/null
          then
              echo "‚ö†Ô∏è JMeter not found! Please install JMeter manually on your Mac."
              exit 1
          fi

      - name: Debug Network & VPN
        run: |
          echo "üîç Checking internet connection..."
          ping -c 4 google.com
          echo "üîç Checking VPN status..."
          ifconfig | grep tun || echo "‚ö†Ô∏è VPN is not detected!"
          echo "üîç Checking API connection..."
          curl -v https://ingress-int.uat.galaxyfinx.in --connect-timeout 10 || echo "‚ö†Ô∏è API is unreachable!"

      - name: Run JMeter Test & Stream Logs to GitHub Actions
        run: |
          echo "üõ† Cleaning up old reports..."
          rm -rf report results.jtl jmeter.log
          mkdir -p report  # ƒê·∫£m b·∫£o th∆∞ m·ª•c report lu√¥n t·ªìn t·∫°i nh∆∞ng r·ªóng
          export JVM_ARGS="-Djavax.net.ssl.trustStore=/etc/ssl/certs/java/cacerts -Djavax.net.ssl.trustStorePassword=changeit -Dhttps.protocols=TLSv1.2,TLSv1.3"
          gtimeout 300 jmeter -n -t backup-vikki-journey.jmx -l results.jtl -j jmeter.log -e -o report | tee jmeter-live.log
          if [ -f "jmeter.log" ]; then tail -f jmeter.log; else echo "‚ùå jmeter.log not found!"; fi

      - name: Upload JMeter Report
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report
          path: report/

      - name: Upload JMeter Logs
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-logs
          path: jmeter.log

      - name: Upload Live Log to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-live-log
          path: jmeter-live.log
