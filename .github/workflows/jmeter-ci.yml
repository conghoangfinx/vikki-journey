name: JMeter CI Test (Manual)

on:
  workflow_dispatch:

jobs:
  jmeter-test:
    runs-on: self-hosted  # Cháº¡y trÃªn mÃ¡y cÃ¡ nhÃ¢n cÃ³ VPN

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install JMeter
        run: |
          brew install jmeter  # CÃ i JMeter trÃªn macOS
          echo "$(brew --prefix jmeter)/bin" >> $GITHUB_PATH

      - name: Debug Network & VPN
        run: |
          echo "ğŸ” Checking internet connection..."
          ping -c 4 google.com
          echo "ğŸ” Checking VPN status..."
          ifconfig | grep tun || echo "âš ï¸ VPN is not detected!"
          echo "ğŸ” Checking API connection..."
          curl -v https://ingress-int.uat.galaxyfinx.in --connect-timeout 10 || echo "âš ï¸ API is unreachable!"

      - name: Run JMeter Test
        run: |
          echo "ğŸ›  Cleaning up old reports..."
          rm -rf report results.jtl jmeter.log  # XÃ³a dá»¯ liá»‡u cÅ© Ä‘á»ƒ trÃ¡nh lá»—i ghi Ä‘Ã¨
          export JVM_ARGS="-Djavax.net.ssl.trustStore=/etc/ssl/certs/java/cacerts -Djavax.net.ssl.trustStorePassword=changeit -Dhttps.protocols=TLSv1.2,TLSv1.3"
          timeout 300 jmeter -n -t backup-vikki-journey.jmx -l results.jtl -j jmeter.log -e -o report &
          tail -f jmeter.log  # Hiá»ƒn thá»‹ log liÃªn tá»¥c

      - name: Upload JMeter Report
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report
          path: report/

      - name: Upload JMeter Logs
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-logs
          path: jmeter.log
