name: JMeter CI Test (Manual)

on:
  workflow_dispatch:

jobs:
  jmeter-test:
    runs-on: self-hosted  # Chạy trên máy cá nhân có VPN

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install JMeter
        run: |
          brew install jmeter  # Cài JMeter trên macOS
          echo "$(brew --prefix jmeter)/bin" >> $GITHUB_PATH

      - name: Run JMeter Test
        run: |
          export JVM_ARGS="-Djavax.net.ssl.trustStore=/etc/ssl/certs/java/cacerts -Djavax.net.ssl.trustStorePassword=changeit -Dhttps.protocols=TLSv1.2,TLSv1.3"
          timeout 300 jmeter -n -t backup-vikki-journey.jmx -l results.jtl -j jmeter.log -e -o report &
          tail -f jmeter.log  # Hiển thị log liên tục

      - name: Upload JMeter Report
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report
          path: report/

      - name: Upload JMeter Logs
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-logs
          path: jmeter.log
